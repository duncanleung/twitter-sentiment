var express=require("express"),bodyParser=require("body-parser"),request=require("request"),_=require("underscore"),Promise=require("bluebird"),Twitter=require("twitter"),datum=require("datumbox").factory("3f370865e56303cf6f145aa40485f1f0"),config=require("./config"),app=express(),router=express.Router(),parseJson=bodyParser.json(),twitter=new Twitter({consumer_key:process.env.TWITTER_CONSUMER_KEY,consumer_secret:process.env.TWITTER_CONSUMER_SECRET,access_token_key:process.env.TWITTER_ACCESS_TOKEN_KEY,access_token_secret:process.env.TWITTER_ACCESS_TOKEN_SECRET}),collectedTweets=[],sentimentCollection=[],keyword="";router.post("/",parseJson,function(e,t){console.log(e.body.query),keyword=e.body.query,twitter.stream("statuses/filter",{language:"en",track:keyword},function(e){function o(e){return new Promise(function(e,t){_.each(collectedTweets,function(e){n(e).then(function(t){r(e,t),console.log("sentiment returned: "+t)})})})}function n(e){return new Promise(function(t,o){datum.twitterSentimentAnalysis(e.text,function(e,n){e?o(e):t(n)})})}function r(e,t){sentimentCollection.push({sentiment:t,created_at:e.created_at,timestamp_ms:e.timestamp_ms,id_str:e.id_str,user:{screen_name:e.user.screen_name,profile_image_url:e.user.profile_image_url,location:e.user.location,time_zone:e.user.time_zone},text:e.text,lang:e.lang}),console.log(sentimentCollection.length),console.log("pushing sentiment")}e.on("data",function(e){console.log("collecting data"),collectedTweets.push(e)}),e.on("error",function(e){throw console.log(e),e}),setTimeout(function(){e.destroy(),console.log("collected "+collectedTweets.length+" tweets"),o().done(t.send(sentimentCollection)),console.log("hopefully nothing after this message...")},5e3)})}),module.exports=router;